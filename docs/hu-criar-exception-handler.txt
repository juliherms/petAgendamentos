História de Usuário — Handler Global de Exceções (Spring Boot)
Contexto

Precisamos padronizar o tratamento de erros da API para retornar respostas consistentes, com detalhes do erro/exceção de negócio capturada e o horário do ocorrido, facilitando o diagnóstico por consumidores e observabilidade por times internos.

História

Como consumidor da API
Quero que exista um ExceptionHandler global e único
Para receber respostas de erro padronizadas contendo código HTTP, mensagem, código de negócio (quando aplicável), detalhes do problema e o timestamp do evento.

Regras de Negócio

Handler Único: deve haver um componente global (ex.: @RestControllerAdvice) responsável por capturar e mapear:

Exceções de negócio (ex.: BusinessException) → HTTP 4xx configurável (padrão 422).

Erros de validação (ex.: MethodArgumentNotValidException, ConstraintViolationException) → 400 com lista de campos inválidos.

Erros não previstos (Exception) → 500 com mensagem genérica e sem stack trace no corpo.

Contrato de Erro (Problem Details):

timestamp: ISO-8601 com offset de fuso (ex.: 2025-08-22T09:30:45-03:00).

status: inteiro HTTP.

error: rótulo curto (ex.: Unprocessable Entity, Bad Request).

code: código de negócio quando aplicável (ex.: USR-001).

message: mensagem legível ao cliente.

details: lista opcional com explicações/campos inválidos.

path: caminho do endpoint.

traceId: identificador de correlação (gerado ou propagado de X-Request-Id).

Conteúdo e Cabeçalhos:

Content-Type: application/problem+json.

Se presente X-Request-Id na requisição, refletir no traceId da resposta.

Fuso Horário:

timestamp deve refletir o horário local do servidor com offset; internamente, logs em UTC.

Segurança da Informação:

Nunca expor stack trace, nomes de classes internas ou credenciais.

Mensagens de 5xx devem ser genéricas; detalhes técnicos apenas em logs.

Observabilidade:

Logar o evento com nível adequado (WARN para 4xx, ERROR para 5xx) incluindo traceId, path, status, code e exceção.

Extensibilidade:

BusinessException deve carregar opcionalmente httpStatus, code e metadata para enriquecer a resposta.